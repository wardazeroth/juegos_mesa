{% extends 'base.html' %}
{%block content%}
{%load static%}
{%load custom_filters%}

<div class="marco">
    <div class="row">
        <div class="col-md-1"></div>
        <div class="col-md-10"> 
            <h3>{{ post.titulo }}</h3> 
            <div class="card text-light" style="margin-top:5rem; padding: 2rem;">
                
                <div class="row">
                    <div class="col-md-2">
                        <img src="{{post.autor.usuario.avatar.url}}" class="img-jugador" alt="">
                    </div>
                    <div class="col-md-6">
                        <h3 class="card-text" style="text-align: left;">{{ post.autor.usuario.alias}}</h3>
                        <p class="card-text" style="text-align: left;">{{ post.fecha_creacion}}</p>    
                    </div>
                </div>

                {%if post.imagenes%}
                <div class="row">                 
                    {%for imagen in post.imagenes.all %} 
                    <div class="col-md-6 mt-3">                               
                        <img src="{{ imagen.imagen.url }}" class="d-block w-100" id="img_comentario" data-imgid = "{{ imagen.imagen.id}}" alt="imagen">
                    </div>
                    {%endfor%}      
                {%endif%}

                {%if post.urls%}
                    {%for url in post.urls.all %} 
                        <div class="col-md-6 mt-3">                               
                            <img src="{{ url }}" class="d-block w-100" id="img_post" data-imgid = "{{ imagen.imagen.id}}" alt="imagen">
                        </div>
                    {%endfor%}
                </div>
                {%endif%}

                {%if post.links%}
                    {%for link in post.links.all %} 
                        <div class="col-md-12 mt-3">                               
                            <a href="{{link}}" target="_blank">{{link}}</a>
                        </div>
                    {%endfor%}
                {%endif%}


                <p class="card-text mt-3"  style="text-align: left">{{ post.contenido}}</p>
                    {%if post.autor == request.user%}
                    
                    <section id="edit-form">
                        <form action="{% url 'editar_post' 'Post' post.id %}" method="post" enctype="multipart/form-data">
                            <div id="imagen-prev-edit-post"></div>
                            <div id="link-prev-post" style="padding: 2rem 0"></div>
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-4">
                                    <a href="#" id="add-link-post" class="btn btn-outline-primary" data-id="{{post.id}}"><i class="fa-solid fa-link"></i> Añadir Link</a>
                                </div>
                                <div class="col-md-4">
                                    <a href="#" class="add-img-edit btn btn-outline-primary" data-id="{{post.id}}"><i class="fa-solid fa-images"></i> Añadir Imagen</a>
                                </div>
                                <div class="col-md-4">
                                    <a href="#" id="add_url_post" class="btn btn-outline-primary mb-3"><i class="fa-solid fa-images"></i> Añadir URL</a>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-5 add_url_post" style="display: none; margin: 0 2rem">
                                    <label for="url" class="form-label">URL</label>
                                    <input name="url_post" type="url" class="form-control" id="url_post" data-model="post" placeholder="Inserte URL de la imagen">
                                    <button type="button" id="add_url_post" onclick="agregarCampo(event)" data-model="post" class="btn btn-outline-primary mb-3 mt-3">Agregar otra URL de imagen</button>
                                </div>
    
                                <div class="col-md-5 add-link-post" style="display: none; margin: 0 2rem">
                                    <label for="link" class="form-label">Link</label>
                                    <input type="url" id="link-post" class="form-control" name="link-post" data-model="post" placeholder="Inserte un link">
                                    <button type="button" id="add_link_post" onclick="agregarLink(event)" data-model="post" class="btn btn-outline-primary mb-3 mt-3">Agregar otro Link</button>
                                </div>
                            </div>

                            <div class="mb-3">
                            <label for="text" class="form-label">Editar</label>
                            <input
                                type="text"
                                class="form-control"
                                name="contenido"
                                id="contenido"
                                placeholder="contenido"
                                value="{{ post.contenido }}"
                                required
                            />
                            <input
                            type="file"
                            class="imagenes-edit"
                            name="imagenes_edit"
                            id="imagenes_edit_post"
                            style="display: none;"
                            placeholder="nueva imagen"
                            value="{{post.imagenes}}"
                            multiple
                            />
                            </div>
                            <div class="row">
                                <div class="col-md-8"></div>
                                <div class="col-md-2">
                                    <div class="actionBar">
                                        <a href="{% url 'reaccionar' 'Post' post.id %}?from=like_post" data-id="{{post.id}}" data-modelo="Post" class="reaccion">
                                        {%if liked_post%}
                                            <i class="fa-solid fa-thumbs-up like"></i>
                                        {%else%}
                                            <i class="fa-regular fa-thumbs-up like"></i>
                                        {%endif%}
                                            {%if post.total_likes > 1%}
                                            <span class="reaction-text">
                                                {{post.total_likes}}
                                            </span> Likes
                                            {%elif post.total_likes == 0 %}
                                            <span class="reaction-text"> 
                                                {{post.total_likes}}
                                            </span> Likes
                                            {%else%}
                                            <span class="reaction-text">
                                                {{post.total_likes}}
                                            </span> Like
                                            {%endif%}
                                        </a>
                                    </div>
                                        
                                </div>
                                <div class="col-md-2">
                                    <a href="#" class="citar btn btn-primary" data-id="{{post.id}}" data-texto="{{post.contenido}}" data-autor="{{post.autor}}" data-modelo="Post">Citar</a>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-1"></div>
                                <div class="col-md-2">
                                    <input type="submit" value="Editar" class="btn btn-primary mt-3">
                                
                                </div>
                                <div class="col-md-2">
                                    <a href="{% url 'detalle_post' 'Post' post.id %}" class="btn btn-danger mt-3" >Cancelar</a>
                                </div>
                            </div>    
                        </form>
                    </section>
                    <section id="extra">
                        <div class="row">
                            <div class="col-md-8"></div>
                            <div class="col-md-2">
                                <div class="actionBar">
                                    <a href="{% url 'reaccionar' 'Post' post.id %}?from=like_post" data-id="{{post.id}}" data-modelo="Post" class="reaccion">
                                    {%if liked_post%}
                                        <i class="fa-solid fa-thumbs-up like"></i>
                                    {%else%}
                                        <i class="fa-regular fa-thumbs-up like"></i>
                                    {%endif%}
                                        {%if post.total_likes > 1%}
                                        <span class="reaction-text">
                                            {{post.total_likes}}
                                        </span> Likes
                                        {%elif post.total_likes == 0 %}
                                        <span class="reaction-text"> 
                                            {{post.total_likes}}
                                        </span> Likes
                                        {%else%}
                                        <span class="reaction-text">
                                            {{post.total_likes}}
                                        </span> Like
                                        {%endif%}
                                    </a>
                                </div>
                                    
                            </div>
                            <div class="col-md-2">
                                <a href="{% url 'detalle_post' 'Post' post.id %}" class="citar btn btn-primary" data-postid="{{post.id}}" data-texto="{{post.contenido}}" data-autor="{{post.autor}}" data-modelo="Post">Citar</a>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-1"></div>
                            <div class="col-md-2">
                                <a href="{% url 'editar_post' 'Post' post.id %}" class="btn btn-primary mt-3 edit-post"  data-id="{{ post.id }}" data-modelo="Post">Editar</a>
                            
                            </div>
                            <div class="col-md-2">
                                <a href="{% url 'eliminar_post' post.id %}" class="btn btn-danger mt-3" onclick="eliminar_post(event, '{{ post.id }}')"><i class="bi bi-trash-fill"></i>Eliminar</a>
                            </div>
                        </div>    
                    </section>         
                    {%else%}
                    <div class="row">
                        <div class="col-md-8"></div>
                        <div class="col-md-2">
                            <div class="actionBar">
                                <a href="{% url 'reaccionar' 'Post' post.id %}?from=like_post" data-id="{{post.id}}" data-modelo="Post" class="reaccion">
                                {%if liked_post%}
                                    <i class="fa-solid fa-thumbs-up like"></i>
                                {%else%}
                                    <i class="fa-regular fa-thumbs-up like"></i>
                                {%endif%}
                                    {%if post.total_likes > 1%}
                                    <span class="reaction-text">
                                        {{post.total_likes}}
                                    </span> Likes
                                    {%elif post.total_likes == 0 %}
                                    <span class="reaction-text"> 
                                        {{post.total_likes}}
                                    </span> Likes
                                    {%else%}
                                    <span class="reaction-text">
                                        {{post.total_likes}}
                                    </span> Like
                                    {%endif%}
                                </a>
                            </div>                                
                        </div>
                        <div class="col-md-2">
                            <a href="{% url 'detalle_post' 'Post' post.id %}" class="citar btn btn-primary" data-postid="{{post.id}}" data-texto="{{post.contenido}}" data-autor="{{post.autor}}" data-modelo="Post">Citar</a>
                        </div>
                    </div>
                {%endif%}

                {%if post.comentarios%}
                {%for com in comentarios%}
                        
                {%if request.user == com.autor%}
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card text-light" style="margin-top:3rem; padding: 2rem;">
                                <div class="row">
                                    <div class="col-md-2">
                                        <img src="{{com.autor.usuario.avatar.url}}" class="img-jugador" alt="">
                                    </div>
                                    <div class="col-md-6">
                                        <h3 class="card-text" style="text-align: left;">{{ com.autor.usuario.alias}}</h3>
                                        <p class="card-text" style="text-align: left;">{{ com.fecha_creacion}}</p>    
                                    </div>
                                </div>
                                {%if com.post_cita%}
                                    <blockquote id="post-cita-cuadro" class="mt-3">
                                        <h6>{{ com.post_cita.autor}} dijo:</h6>
                                        <p>{{ com.post_cita.contenido}}</p>
                                    </blockquote>
                                {%elif com.comentario_cita%}
                                <blockquote id="comentario-cita-cuadro" class="mt-3">
                                    <h6>{{ com.comentario_cita.autor}} dijo:</h6>
                                    <p>{{ com.comentario_cita.mensaje }}</p>
                                </blockquote>
                                {%endif%}

                                {%if com.imagenes%}
                                    <div class="row">                 
                                        {%for imagen in com.imagenes.all %} 
                                        <div class="col-md-6 mt-3">                               
                                            <img src="{{ imagen.imagen.url }}" class="d-block w-100" id="img_comentario" data.imgid = "{{ imagen.imagen.id}}" alt="imagen">
                                        </div>
                                        {%endfor%}                                  
                                {%endif%}

                                {%if com.urls%}
                                        {%for url in com.urls.all %} 
                                        <div class="col-md-6 mt-3">                               
                                            <img src="{{ url }}" class="d-block w-100" id="img_comentario" data.imgid = "{{ imagen.imagen.id}}" alt="imagen">
                                        </div>
                                        {%endfor%}
                                    </div>
                                {%endif%}

                                {%if com.links%}
                                    {%for link in com.links.all %} 
                                        <div class="col-md-12 mt-3">                               
                                            <a href="{{link}}" target="_blank">{{link}}</a>
                                        </div>
                                    {%endfor%}
                                {%endif%}

                                    <p class="card-text mt-3"  style="text-align: left">{{ com.mensaje }}</p>

                                    <section id="edit-comment-form-{{com.id}}">

                                        <div id="imagen-prev-edit-{{com.id}}"></div>
                                        <div id="link-prev-edit-{{com.id}}" style="padding: 2rem 0"></div>
    
                                        <form action="{% url 'editar_comentario' 'Comentario' com.id %}" method="post" enctype="multipart/form-data">
                                            {% csrf_token %}
        
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <a href="#" id="add-link-com" class="btn btn-outline-primary add-link-com" data-id="{{com.id}}"><i class="fa-solid fa-link"></i> Añadir Link</a>
                                                </div>

                                                <div class="col-md-4">
                                                    <a href="#" class="add-img-edit btn btn-outline-primary" data-id="{{com.id}}"><i class="fa-solid fa-images"></i> Añadir Imagen</a>
                                                </div>

                                                <div class="col-md-4">
                                                    <a href="#" class="btn btn-outline-primary mb-3 add_url_btn" data-id="{{com.id}}"><i class="fa-solid fa-images"></i></i> Añadir URL</a>
                                                </div>
                                            </div>

                                            <div class="col-md-6 add_url_com" style="display: none; margin: 0 4rem" data-id="{{com.id}}">
                                                <label for="url" class="form-label">URL</label>
                                                <input name="url_com" type="url" class="form-control" id="url_com_{{com.id}}" data-id="{{com.id}}" data-model="comentario" placeholder="Inserte URL de la imagen">
                                                <button type="button" id="add_url_btn" onclick="agregarCampo(event)" data-id="{{com.id}}" data-model="comentario" class="btn btn-outline-primary mb-3 mt-3">Agregar otra URL de imagen</button>
                                            </div>

                                            <div class="col-md-5 add-link-com-cuadro" style="display: none; margin: 0 2rem" data-id="{{com.id}}">
                                                <label for="link" class="form-label">Link</label>
                                                <input type="url" id="link-com-{{com.id}}" class="form-control" name="link-com" data-model="comentario" data-id="{{com.id}}" placeholder="Inserte un link">
                                                <button type="button" id="add_link_com" onclick="agregarLink(event)" data-model="comentario" data-id="{{com.id}}" class="btn btn-outline-primary mb-3 mt-3">Agregar otro Link</button>
                                            </div>

                                            <div class="mb-3">
                                                <label for="text" class="form-label">Editar</label>
                                                <input
                                                    type="text"
                                                    class="form-control"
                                                    name="mensaje"
                                                    id="mensaje"
                                                    placeholder="mensaje"
                                                    value="{{ com.mensaje }}"
                                                    required
                                            />

                                            <input
                                            type="file"
                                            class="imagenes-edit"
                                            name="imagenes_edit"
                                            id="imagenes_edit-{{com.id}}"
                                            style="display: none;"
                                            placeholder="nueva imagen"
                                            value="{{comentario.imagenes}}"
                                            multiple
                                            />

                                            </div>
                                            <div class="row">
                                                <div class="col-md-8"></div>
                                                <div class="col-md-2">
                                                    <div class="actionBar">
                                                        <a href="{% url 'reaccionar' 'Comentario' com.id %}" class="reaccion" data-id="{{ com.id }}" data-modelo = 'Comentario'>
                                                        {%if liked_coments|get_item:com.id%}
                                                            <i class="fa-solid fa-thumbs-up like"></i>
                                                        {% else %}
                                                            <i class="fa-regular fa-thumbs-up like"></i>
                                                        {%endif%}
                                                            {%if com.total_likes > 1%}
                                                            <span class="reaction-text">
                                                                {{com.total_likes}} 
                                                            </span> Likes
                                                            {%elif com.total_likes == 0 %}
                                                            <span class="reaction-text">
                                                                {{com.total_likes}}
                                                            </span> Likes
                                                            {%else%}
                                                            <span class="reaction-text">
                                                                {{com.total_likes}} 
                                                            </span> Like
                                                            {%endif%}
                                                        </a>
                                                    </div>
                                                </div>
                                                <div class="col-md-2">
                                                    <a href="{% url 'detalle_post' 'Comentario' com.id %}" class="citar btn btn-primary" data-comentarioid="{{com.id}}" data-texto="{{com.mensaje}}" data-autor="{{com.autor}}" data-modelo="Comentario">Citar</a>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-1"></div>
                                                <div class="col-md-2">
                                                    <input type="submit" value="Editar" class="btn btn-primary mt-3">
                                                </div>
                                                <div class="col-md-2">
                                                    <a href="{% url 'detalle_post' 'Comentario' com.id %}" class="btn btn-danger mt-3" >Cancelar</a>
                                                </div>
                                            </div>
                                        </form>


                                    </section>

                                    <section id="extra-2-{{com.id}}">
                                        <div class="row">
                                            <div class="col-md-8"></div>
                                            <div class="col-md-2">
                                                <div class="actionBar">
                                                    <a href="{% url 'reaccionar' 'Comentario' com.id %}" class="reaccion" data-id="{{ com.id }}" data-modelo = 'Comentario'>
                                                    {%if liked_coments|get_item:com.id%}
                                                        <i class="fa-solid fa-thumbs-up like"></i>
                                                    {% else %}
                                                        <i class="fa-regular fa-thumbs-up like"></i>
                                                    {%endif%}
                                                        {%if com.total_likes > 1%}
                                                        <span class="reaction-text">
                                                            {{com.total_likes}} 
                                                        </span> Likes
                                                        {%elif com.total_likes == 0 %}
                                                        <span class="reaction-text">
                                                            {{com.total_likes}}
                                                        </span> Likes
                                                        {%else%}
                                                        <span class="reaction-text">
                                                            {{com.total_likes}} 
                                                        </span> Like
                                                        {%endif%}
                                                    </a>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <a href="{% url 'detalle_post' 'Comentario' com.id %}" class="citar btn btn-primary" data-comentarioid="{{com.id}}" data-texto="{{com.mensaje}}" data-autor="{{com.autor}}" data-modelo="Comentario">Citar</a>
                                            </div>
                                        </div>
                                    
                                        <div class="row">
                                            <div class="col-md-1"></div>
                                            <div class="col-md-2">
                                                <a href="{% url 'editar_comentario' 'Comentario' com.id %}" class="btn btn-primary mt-3 edit-comment"  data-id="{{ com.id }}" data-modelo="Comentario">Editar</a>
                                            </div>
                                            <div class="col-md-2">
                                                <a href="{% url 'eliminar_comentario' com.id %}" class="btn btn-danger mt-3" onclick="eliminar_comment(event, '{{ com.id }}')"><i class="bi bi-trash-fill"></i>Eliminar</a>
                                            </div>
                                        </div>
                                        
                                    </section>
                                </div>
                            
                                {%else%}
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card text-light" style="margin-top:3rem; padding: 2rem;">
                                <div class="row">
                                    <div class="col-md-2">
                                        <img src="{{com.autor.usuario.avatar.url}}" class="img-jugador" alt="">
                                    </div>
                                    <div class="col-md-6">
                                        <h3 class="card-text" style="text-align: left;">{{ com.autor.usuario.alias}}</h3>
                                        <p class="card-text" style="text-align: left;">{{ com.fecha_creacion}}</p>    
                                    </div>
                                </div>
                                <p class="card-text mt-3"  style="text-align: left">{{ com.mensaje }}</p>
                                <div class="row">
                                    <div class="col-md-8"></div>
                                    <div class="col-md-2">
                                        <div class="actionBar">
                                            <a href="{% url 'reaccionar' 'Comentario' com.id %}" class="reaccion" data-id="{{ com.id }}" data-modelo = 'Comentario'>
                                            {%if liked_coments|get_item:com.id%}
                                                <i class="fa-solid fa-thumbs-up like"></i>
                                            {% else %}
                                                <i class="fa-regular fa-thumbs-up like"></i>
                                            {%endif%}
                                                {%if com.total_likes > 1%}
                                                <span class="reaction-text">
                                                    {{com.total_likes}} 
                                                </span> Likes
                                                {%elif com.total_likes == 0 %}
                                                <span class="reaction-text">
                                                    {{com.total_likes}}
                                                </span> Likes
                                                {%else%}
                                                <span class="reaction-text">
                                                    {{com.total_likes}} 
                                                </span> Like
                                                {%endif%}
                                            </a>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <a href="" class="citar btn btn-primary" data-comentarioid="{{com.id}}" data-texto="{{com.mensaje}}" data-autor="{{com.autor}}" data-modelo="Comentario">Citar</a>
                                    </div>
                                </div>
                            </div>
                        {%endif%}               
                </div>
            </div>
            {%endfor%}
            {%endif%}
        
    
                    </div>

    <section id="formulario">
        <div class="row">
            
            <div class="col-md-8 offset-md-3">
                <h3 class="text-center pt-5 pb-3">Responder</h3>
                <div class="marco-editor">
                    <div class="row">
                        <div class="col-md-4">
                            <a href="#" id="add-link" class="btn btn-outline-primary"><i class="fa-solid fa-link"></i> Añadir Link</a>
                        </div>

                        <div class="col-md-4">
                            <a href="#" id="add_img" class="btn btn-outline-primary mb-3"><i class="fa-solid fa-images"></i> Añadir Imagen</a>
                        </div>

                        <div class="col-md-4">
                            <button type="button" id="add_url" class="btn btn-outline-primary mb-3"><i class="fa-solid fa-images"></i>Añadir URL</button>
                        </div>
                    </div>
                <form action= "{% url 'detalle_post' 'Post' post.id %}" method="post" enctype="multipart/form-data">
                    <div id="previsual_resp"></div>
                    <div id="link-prev-resp" style="padding: 2rem 0"></div>
                    {%csrf_token%}
                    <input type="hidden" id="post_cita" name="post_cita">
                    <input type="hidden" id="comentario_cita" name="comentario_cita">
                    <input
                    type="file"
                    class="form-control"
                    name="imagenes"
                    id="imagenes"
                    style="display: none;"
                    placeholder="nueva imagen"
                    value="{{comentario.imagenes}}"
                    multiple
                    />

                    <div class="mb-3 add_url" style="display: none; margin: 0 4rem">
                        <label for="url" class="form-label">URL</label>
                        <input name="url" type="url" class="form-control" id="url" data-model="respuesta" placeholder="Inserte URL de la imagen">
                        <button type="button" id="add_url_resp" onclick="agregarCampo(event)" data-model="respuesta" class="btn btn-outline-primary mb-3 mt-3">Agregar otra URL de imagen</button>
                    </div>

                    <div class="col-md-5 add-link" style="display: none; margin: 0 2rem">
                        <label for="link" class="form-label">Link</label>
                        <input type="url" id="link-resp" class="form-control" name="link-resp" data-model="respuesta" placeholder="Inserte un link">
                        <button type="button" id="add_link_respuesta" onclick="agregarLink(event)" data-model="respuesta" class="btn btn-outline-primary mb-3 mt-3">Agregar otro Link</button>
                    </div>

                    <div id="post-cita" style="display: none;" name="post_cita">
                        <pre></pre>
                    </div> 

                    <div id="comentario-cita" style="display: none;" name="comentario_cita">
                        <pre></pre>
                    </div>

                        {%for field in form%}   
                        <div class="mb-3">
                            {{ field }}
                        </div>
                        {%endfor%}
                    
                    <div class="row">
                        <div class="col-md-8">
                            <a href="#" id="add_archivo" class="btn btn-outline-primary mb-1"><i class="fa-solid fa-paperclip"></i> Añadir Archivo</a>
                        </div>
                        
                        <div class="col md-4">
                            <input type="submit" data-id="{{com.id}}" data-modelo="{{Comentario}}" value="Enviar"  class="btn btn-outline-success mb-1">
                        </div>
                    </div>
                    
                </form>
            
            </div>
        </div>
    </div>
    </section>


    <div class="row">
        
        {%if user.is_authenticated%}

        <div class="col-md-10"></div>
                <div class="col-md-2">
                    <button id="responder" class="btn btn-primary mt-3">Responder</button>
                </div>
        {%else%}
            <div class="col-8"></div>
                <div class="col-md-4">
                        <a href='#' class="btn btn-primary mt-3">Debes estar autenticado para responder</a>
                </div>
        {%endif%}
    </div>
    


{%endblock%}

{%block js%}
<script>
    function eliminar_post(event, id) {
        event.preventDefault()
        const url = '/foro/' + id +'/eliminar_post'

        debugger
        const confirmacion = confirm('¿Está seguro que desea eliminar este post?')
        if (confirmacion == true) {
            window.location.href = url
        }
    }
</script>

<script>
    function eliminar_comment(event, id) {
        event.preventDefault()
        const url = '/foro/' + id +'/eliminar_comentario'

        debugger
        const confirmacion = confirm('¿Está seguro que desea eliminar este comentario?')
        if (confirmacion == true) {
            window.location.href = url
        }
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('.reaccion').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();

                let comentarioId = this.dataset.id;
                let modelo= this.dataset.modelo;
                let likeIcon = this.querySelector('i'); //ícono del botón)
                let likeCount = this.querySelector('.reaction-text');

                fetch(`/foro/${modelo}/${comentarioId}/like`, {
                    method: 'POST',
                    headers: {
                    "X-CSRFToken": getCSRFToken(), // Necesario para Django
                    "X-Requested-With": "XMLHttpRequest"
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Actualizar el número de likes
                    likeCount.textContent = data.total_likes;

                    //Cambiar la clase del ícono
                    if (data.liked) {
                        likeIcon.classList.remove('fa-regular');
                        likeIcon.classList.add('fa-solid');
                    }else {
                        likeIcon.classList.remove('fa-solid');
                        likeIcon.classList.add('fa-regular');
                    }
                })
                .catch(error =>console.error('Error:', error));
            });
        });

        function getCSRFToken() {
            return document.querySelector("[name=csrfmiddlewaretoken]").value;
        }
    });

            document.addEventListener('DOMContentLoaded', function(){
            document.getElementById('responder').addEventListener('click', function(event) {
                event.preventDefault();
                document.getElementById('formulario').style.display='block'
                document.getElementById('responder').style.display= 'none';
                
        });
    });

    const imagenes_resp = document.getElementById('imagenes')
    const prev_resp = document.getElementById('previsual_resp')
    const fomularioRespuesta = document.getElementById('formulario')

    let agregar_img = []
    let elim_resp = []

    imagenes_resp.addEventListener('change', () => {
        let archivos = imagenes_resp.files
        for (let i=0; i < archivos.length; i++) {
            
            console.log('hay lista: ', agregar_img)
            const file = archivos[i]
            const reader = new FileReader();    
            const container = document.createElement('div');
            container.classList.add('imagen-container')
            const img = document.createElement('img');
            const trashIcono = document.createElement('i')
            trashIcono.classList.add('fas', 'fa-trash-alt', 'borrar-icon')

        trashIcono.addEventListener('click', function() {
            container.remove();
            elim_resp.push(archivos[i])
            console.log('eliminando: ', elim_resp)
        })

        reader.onload = function(e) {
            // convert image file to base64 string
            img.src = reader.result
            container.appendChild(img)
            container.appendChild(trashIcono)
            prev_resp.appendChild(container)
            prev_resp.style.display = 'block';
            agregar_img.push(archivos[i])

            console.log('cargadas para enviar', agregar_img)
            let dataTransfer = new DataTransfer()
            for (let file of agregar_img) {
                dataTransfer.items.add(file)
            }
            imagenes_resp.files = dataTransfer.files
        }
        reader.readAsDataURL(archivos[i]);
        }
    });

    document.getElementById("add_img").addEventListener('click', function (e) {
        e.preventDefault();
        imagenes_resp.click()
    });

    fomularioRespuesta.addEventListener('submit', function enviarForm(e) {
        const id = this.dataset.id;
        console.log('eliminadas: ', elim_resp);
        let form = e.target                  
        let formData = new FormData(form);

        formData.append('imagenes_eliminadas', JSON.stringify(elim_resp));

        fetch(`/foro/${modelo}/${id}/edit-foto`,  {
        method: 'POST',
        body: formData,
        headers: {
        "X-CSRFToken": getCSRFToken(),
        "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('imágenes actualizadas')
    })
    .catch(error=> {
        console.log('Error:', error)});   
});


        document.querySelectorAll('.citar').forEach(button => {
            button.addEventListener('click', function(event) {
            event.preventDefault();
            document.getElementById('formulario').style.display='block'
            document.getElementById('formulario').scrollIntoView({ behavior: 'smooth' });

            document.getElementById('responder').style.display= 'none';

            let contenidoCita = this.dataset.texto;

            let modelo = this.dataset.modelo
            let autorCita = this.dataset.autor;
            let cita = `${autorCita}:\n${contenidoCita}\n`

            if (modelo == 'Post') {
                let post_id = this.dataset.postid || None;
                document.getElementById('post_cita').value = post_id

                let citaTexto = document.getElementById('post-cita')
                citaTexto.style.display='block';
                citaTexto.querySelector('pre').textContent = cita
            } else {
                let comentario_id = this.dataset.comentarioid || None;
                document.getElementById('comentario_cita').value = comentario_id

                let citaTexto= document.getElementById('comentario-cita')
                citaTexto.style.display='block';
                citaTexto.querySelector('pre').textContent = cita
            }
        });
    });

    let imagenes_list = []
    document.getElementById('imagenes').addEventListener('change', function(event) {        
        let imagenes = event.target.files;
        let previsual = document.getElementById('imagen-prev')

        for (let i=0; i < imagenes.length; i++) {
            const file = imagenes[i]
            const reader = new FileReader();
            const container = document.createElement('div');
            container.classList.add('imagen-container')

            console.log(imagenes_list)  

            const img = document.createElement('img');
            const trashIcono = document.createElement('i')
            trashIcono.classList.add('fas', 'fa-trash-alt', 'borrar-icon')

            trashIcono.addEventListener('click', function() {
                container.remove();
        
                console.log(imagenes_list)
                imagenes_list = imagenes_list.filter(f => f !== file)
                let dataTransfer = new DataTransfer()
                for (let f of imagenes_list) {
                    dataTransfer.items.add(f)
                }

                document.getElementById('imagenes').files = dataTransfer.files
            })

            reader.onload = function(e) {
                // convert image file to base64 string
                img.src = reader.result
                container.appendChild(img)
                container.appendChild(trashIcono)
                previsual.appendChild(container)

                previsual.style.display = 'block';
                imagenes_list.push(imagenes[i])

                let dataTransfer = new DataTransfer()
                for (let file of imagenes_list) {
                    dataTransfer.items.add(file)
                }
                document.getElementById('imagenes').files = dataTransfer.files
            }
            reader.readAsDataURL(imagenes[i]);
    }

});
    
    document.addEventListener('DOMContentLoaded', function () {    
        document.addEventListener('click', function (event) {
            if (event.target.classList.contains('add-img-edit')) {
                event.preventDefault();
                images = document.getElementById('imagenes_edit')
                
                const form = event.target.closest('form');
                const input = form.querySelector('.imagenes-edit');
                if (input) {
                    input.click();
                }
            }
        });
    });

        document.querySelectorAll('.edit-post').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                let postId = this.dataset.id;
                let formularioEdicionPost = document.getElementById('edit-form');
                let extra = document.getElementById('extra')
                let modelo = this.dataset.modelo
                let imagenes_edit = document.getElementById('imagenes_edit_post')
                let previsual = document.getElementById('imagen-prev-edit-post')
                
                abrirEditorComentario({ modelo: modelo, id: postId, formularioEdicion: formularioEdicionPost, extra: extra, imagenes_edit: imagenes_edit, previsual: previsual });
        });
    });

    document.querySelectorAll('.edit-comment').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            let comentarioId = this.dataset.id;
            let formularioEdicionComment = document.getElementById(`edit-comment-form-${comentarioId}`);
            let extra = document.getElementById(`extra-2-${comentarioId}`)
            let modelo = this.dataset.modelo
            let imagenes_edit = document.getElementById(`imagenes_edit-${comentarioId}`)
            let previsual = document.getElementById(`imagen-prev-edit-${comentarioId}`)

            abrirEditorComentario({ modelo: modelo, id: comentarioId, formularioEdicion: formularioEdicionComment, extra: extra, imagenes_edit: imagenes_edit, previsual: previsual });
        });
    });
    
    function abrirEditorComentario({modelo, id, formularioEdicion, extra, imagenes_edit, previsual}) {
        if (formularioEdicion) {
                formularioEdicion.style.display='block'
                extra.style.display='none'            
            } else {
                console.error(`No se encontró el formulario para el comentario con ID: ${id}`);
            }
            let imagenes_add = []
            let eliminar_img= []

            obtener_imagenes_backend({modelo: modelo, id:id, previsual:previsual, eliminar_img: eliminar_img});

            imagenes_edit.addEventListener('change', () => {
                let archivos = imagenes_edit.files
                for (let i=0; i < archivos.length; i++) {
                    
                    console.log('hay lista: ', imagenes_add)
                    const file = archivos[i]
                    const reader = new FileReader();
                    const container = document.createElement('div');
                    container.classList.add('imagen-container')
                    const img = document.createElement('img');
                    const trashIcono = document.createElement('i')
                    trashIcono.classList.add('fas', 'fa-trash-alt', 'borrar-icon')

                trashIcono.addEventListener('click', function() {
                    container.remove();

                })

                reader.onload = function(e) {
                    // convert image file to base64 string
                    img.src = reader.result
                    container.appendChild(img)
                    container.appendChild(trashIcono)
                    previsual.appendChild(container)
                    previsual.style.display = 'block';
                    imagenes_add.push(archivos[i])

                    console.log('cargadas para enviar', imagenes_add)
                    let dataTransfer = new DataTransfer()
                    for (let file of imagenes_add) {
                        dataTransfer.items.add(file)
                    }
                    imagenes_edit.files = dataTransfer.files
                }
                reader.readAsDataURL(archivos[i]);
                }
            })

                formularioEdicion.addEventListener('submit', function enviarForm(e) {
                    console.log('eliminadas: ', eliminar_img);
                    let form = e.target                  
                    let formData = new FormData(form);

                    formData.append('imagenes_eliminadas', JSON.stringify(eliminar_img));

                    fetch(`/foro/${modelo}/${id}/edit-foto`,  {
                    method: 'POST',
                    body: formData,
                    headers: {
                    "X-CSRFToken": getCSRFToken(),
                    "X-Requested-With": "XMLHttpRequest"
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('imágenes actualizadas')
                })
                .catch(error=> {
                    console.log('Error:', error)});   
            });
    }

    function obtener_imagenes_backend({modelo, id, previsual, eliminar_img}) {
        fetch(`/foro/${modelo}/${id}/edit-foto`,  {
                    method: 'GET',
                    headers: {
                    "X-CSRFToken": getCSRFToken(),
                    "X-Requested-With": "XMLHttpRequest"
                    }
                })
                .then(response => response.json())
                .then(data => {
                    let images = data.imagenes
                    
                    if (images) {
                        for (let imgData of images) {
                            const container = document.createElement('div');
                            container.classList.add('imagen-container')

                            const img = document.createElement('img');
                            if (imgData['tipo'] == 'file') {
                                img.src =  `/media/${imgData.src}`
                            } else {
                                img.src = imgData.src
                            }
                            
                            const trashIcono = document.createElement('i')
                            trashIcono.classList.add('fas', 'fa-trash-alt', 'borrar-icon')
                            container.appendChild(img)
                            container.appendChild(trashIcono)
                            previsual.appendChild(container)

                            previsual.style.display = 'block';

                            trashIcono.addEventListener('click', function() {
                                container.remove();
                                eliminar_img.push(imgData)
                                console.log("Lista actual de eliminadas:", eliminar_img);                       
                        })
                }
            }
        }).catch(error =>console.error('Error:', error));
    }       

function getCSRFToken() {
    return document.querySelector("[name=csrfmiddlewaretoken]").value;
    }


    document.querySelectorAll('.add_url_btn').forEach(btn => {
        btn.addEventListener('click', function(e){
            e.preventDefault();
            const id = this.dataset.id;

            bloque = document.querySelector(`.add_url_com[data-id="${id}"]`)
            if (bloque) {
                bloque.style.display = 'block';
            }
        })
    });

    document.querySelectorAll('.add-link-com').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const id= this.dataset.id;
            console.log('holaaa chwee')
            let add_link_com = document.querySelector(`.add-link-com-cuadro[data-id="${id}"]`)
            add_link_com.style.display = 'block'
        })
    })

    document.getElementById('add_url').addEventListener('click', function(e){
        e.preventDefault();
        let url_add =document.querySelector('.add_url');
        url_add.style.display = 'block';
    })

    document.addEventListener('DOMContentLoaded', () => {
        const addLinkPost = document.getElementById('add-link-post')

        if (addLinkPost) {
            addLinkPost.addEventListener('click', function(e) {
                e.preventDefault();
                let add_link_post = document.querySelector('.add-link-post');
                add_link_post.style.display = 'block';
            })
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const addLink = document.getElementById('add-link')
        if (addLink) {
            addLink.addEventListener('click', function(e) {
                e.preventDefault();
                let add_link = document.querySelector('.add-link');
                add_link.style.display = 'block';
            })
        }
    })

    document.addEventListener('DOMContentLoaded', () => {
        const addUrlPost = document.getElementById('add_url_post')

        if (addUrlPost) {
            addUrlPost.addEventListener('click', function(e) {
                e.preventDefault();
                let url_add =document.querySelector('.add_url_post');
                url_add.style.display = 'block';
            })
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const inputs = document.querySelectorAll('input[type="url"]');

        inputs.forEach((input) =>{
            input.addEventListener('input', (event) => {
                const inputId = event.target.id
                const dataId = event.target.dataset.id
                const modelo = event.target.dataset.model
                let inputPrincipal = null
                let previsual_form = null
                let inputLink = null
                let prevLink = null

                if (modelo === 'post') {
                    inputPrincipal = document.getElementById('url_post')
                    previsual_form = document.getElementById('imagen-prev-edit-post')
                    inputLink = document.getElementById('link-post')
                    prevLink = document.getElementById("link-prev-post")
                    
                } else if (modelo === 'comentario') {
                    inputPrincipal = document.getElementById(`url_com_${dataId}`)
                    previsual_form = document.getElementById(`imagen-prev-edit-${dataId}`)
                    inputLink = document.getElementById(`link-com-${dataId}`)
                    prevLink = document.getElementById(`link-prev-edit-${dataId}`)
                } else if(modelo === 'respuesta') {
                    inputPrincipal = document.getElementById('url')
                    previsual_form = document.getElementById('previsual_resp')
                    inputLink = document.getElementById('link-resp')
                    prevLink = document.getElementById('link-prev-resp')
                }
                
            previsual_form.style.display = 'block';
            const url = inputPrincipal.value;
            const link = inputLink.value;
            prevLink.style.display = 'block'
            const linked = `<a href="${link}" target="_blank">${link}</a>`
            prevLink.innerHTML = linked

            if (!url) return;

            const container = document.createElement('div');
            container.classList.add('imagen-container')
            const img = document.createElement('img');
            img.src = url;

            const trashIcono = document.createElement('i')
            trashIcono.classList.add('fas', 'fa-trash-alt', 'borrar-icon')

            trashIcono.addEventListener('click', function() {
                container.remove();
                input.value = '';
                })
                container.appendChild(img)
                container.appendChild(trashIcono)
                previsual_form.appendChild(container)
                previsual_form.style.display = 'block';
                })
            })
        });

    function agregarCampo(event) {
        const boton = event.target
        const modelo = event.target.dataset.model
        const dataId = event.target.dataset.id
        let previsual_form = null;
        let contenedor = null;
        const input = document.createElement('input')

            if ( modelo === 'post') {
        // if (boton.id === 'add_url_post') {
            contenedor = document.querySelector('.add_url_post');
            previsual_form = document.getElementById('imagen-prev-edit-post')
            input.type = 'url';
            input.name = 'url_post';
            input.class = "form-control"
            input.style = "margin: 5px 5px; border-radius: 5px"
            input.placeholder = 'URL de imagen';
            contenedor.appendChild(input)

            } else if ( modelo === 'comentario') {
        // }else if (boton.id === 'add_url_com') {
            contenedor = document.querySelector(`.add_url_com[data-id="${dataId}"]`);
            previsual_form = document.getElementById(`imagen-prev-edit-${dataId}`)
            input.type = 'url';
            input.name = 'url_com';
            input.class = "form-control"
            input.style = "margin: 5px 5px; border-radius: 5px"
            input.placeholder = 'URL de imagen';
            contenedor.appendChild(input)
            
            } else if ( modelo === 'respuesta') {
        // } else if (boton.id === 'add_url_com_btn') {
            contenedor = document.querySelector('.add_url');
            previsual_form = document.getElementById('previsual_resp')
            input.type = 'url';
            input.name = 'url';
            input.class = "form-control"
            input.style = "margin: 5px 5px; border-radius: 5px"
            input.placeholder = 'URL de imagen';
            contenedor.appendChild(input)
        }

        previsual_form.style.display = 'block';
        input.addEventListener('input', () => {
            const url = input.value;

            if (!url) return;

            const container = document.createElement('div');
            container.classList.add('imagen-container')
            const img = document.createElement('img');
            img.src = url;

            const trashIcono = document.createElement('i')
            trashIcono.classList.add('fas', 'fa-trash-alt', 'borrar-icon')

            trashIcono.addEventListener('click', function() {
                container.remove();
                input.value = '';
            })
                container.appendChild(img)
                container.appendChild(trashIcono)
                previsual_form.appendChild(container)
                previsual_form.style.display = 'block';
        });

    }

    function agregarLink(event) {
        const boton = event.target
        const modelo = event.target.dataset.model
        const dataId = event.target.dataset.id
        let previsual_form = null;
        let contenedor = null;
        const input = document.createElement('input')

        if ( modelo === 'post') {
        // if (boton.id === 'add_url_post') {
            contenedor = document.querySelector('.add-link-post');
            previsual_form = document.getElementById('link-prev-post')
            input.type = 'url';
            input.name = 'link-post';
            input.class = "form-control"
            input.style = "margin: 5px 5px; border-radius: 5px"
            input.placeholder = 'Inserte un nuevo link';
            contenedor.appendChild(input)

            } else if ( modelo === 'comentario') {
        // }else if (boton.id === 'add_url_com') {
            contenedor = document.querySelector(`.add-link-com-cuadro[data-id="${dataId}"]`);
            previsual_form = document.getElementById(`link-prev-edit-${dataId}`)
            input.type = 'url';
            input.name = 'link-com';
            input.class = "form-control"
            input.style = "margin: 5px 5px; border-radius: 5px"
            input.placeholder = 'Inserte un nuevo link';
            contenedor.appendChild(input)
            
            } else if ( modelo === 'respuesta') {
        // } else if (boton.id === 'add_url_com_btn') {
            contenedor = document.querySelector('.add-link');
            previsual_form = document.getElementById("link-prev-resp")
            input.type = 'url';
            input.name = 'link-resp';
            input.class = "form-control"
            input.style = "margin: 5px 5px; border-radius: 5px"
            input.placeholder = 'URL de imagen';
            contenedor.appendChild(input)
        }

        previsual_form.style.display = 'block';
        input.addEventListener('input', () => {
            const url = input.value;

            if (!url) return;

            const container = document.createElement('div');
            const enlace = document.createElement('a')
            enlace.href = url
            enlace.textContent = url;
            enlace.target = "_blank";
            container.appendChild(enlace)
            container.style = 'padding: 1rem 0'
            previsual_form.appendChild(container)
            previsual_form.style.display = 'block';
        });
    }

</script>

{%endblock%}